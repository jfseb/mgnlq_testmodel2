{"version":3,"sources":["/projects/nodejs/botbuilder/mgnlq_model//projects/nodejs/botbuilder/mongoose_record_replay/src/../src/migrate/model2schema.ts"],"names":[],"mappings":"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","file":"model2schema.js","sourcesContent":["'use strict'\r\n\r\n/**\r\n * (C) gerd forstmann 2017\r\n *\r\n * convert model file into an mongoose schema\r\n */\r\n\r\n//import * as intf from 'constants';\r\nimport * as debug from 'debug';\r\n\r\nimport * as _ from 'lodash';\r\n\r\n//import { IFModel }*  as IFModel  from '../match/ifmatch';\r\n\r\n\r\nimport { IFModel as IFModel } from 'mgnlq_model';\r\n//var IFModel = IFMatch.IModel;\r\n\r\nvar debuglog = debug('model');\r\n\r\nimport * as fs from 'fs';\r\n\r\nimport * as mongoose from 'mongoose';\r\n\r\n\r\n\r\n///////////////////////////////////////////////\r\n// hardcoded mappings\r\n\r\n// these string properties are wrapped into an array, splitting at ,\r\n// and trimming\r\n\r\nvar splitArrComma = {\r\n    \"FioriBOM\": {\r\n        // TODO: fiori intent must be reconstructed after splitting SemanticObject/SEemanticAction\r\n        \"fiori intent\": true,\r\n        \"TransactionCode\": true,\r\n        \"BusinessGroupName\": true,\r\n        ApplicationType: true,\r\n        BusinessRoleName: true,\r\n        BusinessCatalog: true,\r\n        BusinessGroupDescription: true,\r\n        SemanticObject: true,\r\n        SemanticAction: true,\r\n    }\r\n};\r\n\r\n\r\n\r\n\r\n\r\n\r\nexport interface OldCategoryDesc {\r\n    name: string;\r\n    description?: string;\r\n    key?: string;\r\n    QBE?: boolean,\r\n    defaultWidth?: number,\r\n    importance: number,\r\n    LUNRIndex: boolean,\r\n    QBEInclude: boolean\r\n};\r\n\r\nexport interface IOldModel {\r\n    domain: string;\r\n    bitindex: number;\r\n    description?: string;\r\n    tool?: any,\r\n    toolhidden?: boolean;\r\n    synonyms?: {\r\n        [key: string]: string[];\r\n    };\r\n    categoryDescribed: OldCategoryDesc[],\r\n    category: string[];\r\n    columns?: string[];\r\n    wordindex: string[];\r\n    exactmatch?: string[];\r\n    hidden: string[];\r\n}\r\nexport function makeMongoName(s: string): string {\r\n    return s.replace(/[^a-zA-Z0-9]/g, '_');\r\n}\r\n\r\nexport function readFileAsJSON(filename: string): any {\r\n    var data = fs.readFileSync(filename, 'utf-8');\r\n    try {\r\n        return JSON.parse(data);\r\n    } catch (e) {\r\n        console.log(\"Content of file \" + filename + \" is no json\" + e);\r\n        process.exit(-1);\r\n    }\r\n    return undefined;\r\n}\r\n\r\n\r\nexport function loadModel(modelPath: string, sModelName: string) {\r\n    debuglog(\" loading \" + sModelName + \" ....\");\r\n    var oMdl = readFileAsJSON(modelPath + '/' + sModelName + \".model.json\") as IOldModel;\r\n    return oMdl;\r\n    //mergeModelJson(sModelName, oMdl);\r\n    //    loadModelData(modelPath, oMdl, sModelName, oModel);\r\n}\r\n\r\n\r\nexport function loadModelData(modelPath: string, sModelName: string): any[] {\r\n    debuglog(\" loading \" + sModelName + \" ....\");\r\n    var oMdlData = readFileAsJSON(modelPath + '/' + sModelName + \".data.json\") as any;\r\n    return oMdlData;\r\n}\r\n\r\n\r\nexport function calcMongoCats(cats: string[]): string[] {\r\n    var props = {};\r\n    var res = cats.map(cat => {\r\n        var r = makeMongoName(cat);\r\n        if (props[r]) {\r\n            throw new Error(`${props[r]} and ${cat} yield conflicting mongodb property names`);\r\n        }\r\n        props[r] = cat;\r\n        return r;\r\n    });\r\n    return res;\r\n}\r\n\r\nexport function getTextIndexCategories(oMdl: IOldModel): string[] {\r\n    return _.difference(oMdl.wordindex, oMdl.exactmatch);\r\n}\r\n\r\nexport function makeModelDoc(sModelName: string, oMdl: IOldModel): IFModel.IModelDoc {\r\n    var res = {} as IFModel.IModelDoc;\r\n    res.domain = oMdl.domain;\r\n    res.domain_description = oMdl.description;\r\n    res.modelname = sModelName,\r\n        res.collectionname = sModelName;\r\n    res._categories = [];\r\n    oMdl.category.forEach(cat => {\r\n        var categoryDesc = oMdl.categoryDescribed.filter(catrec => catrec.name === cat)[0] || {} as OldCategoryDesc;\r\n        var QBEColumnProps = {} as IFModel.QBEColumnProp;\r\n\r\n        if (categoryDesc.QBE) {\r\n            QBEColumnProps.QBE = categoryDesc.QBE;\r\n        }\r\n        if (categoryDesc.LUNRIndex) {\r\n            QBEColumnProps.LUNRIndex = categoryDesc.LUNRIndex;\r\n        }\r\n        if (categoryDesc.defaultWidth) {\r\n            QBEColumnProps.defaultWidth = categoryDesc.defaultWidth || 100;\r\n        };\r\n        var mem =\r\n            {\r\n                category: cat,\r\n                category_description: categoryDesc.description || \"\",\r\n                QBEColumnProps: QBEColumnProps\r\n            } as IFModel.IModelCategoryRec;\r\n        if (oMdl.wordindex.indexOf(cat) >= 0) {\r\n            mem.wordindex = true;\r\n        }\r\n        if (oMdl.exactmatch.indexOf(cat) >= 0) {\r\n            mem.exactmatch = true;\r\n        }\r\n        if (oMdl.synonyms && oMdl.synonyms[cat]) {\r\n            mem.category_synonyms = oMdl.synonyms[cat];\r\n        }\r\n        if (categoryDesc.QBEInclude) {\r\n            mem.QBEColumnProps.QBEInclude = true;\r\n        }\r\n        // if(categoryDesc.importance) {\r\n        //      mem.importance = categoryDesc.importance;\r\n        //}\r\n        res._categories.push(mem);\r\n    });\r\n    res.columns = oMdl.columns;\r\n    return res;\r\n}\r\n\r\nexport function isArrayTransform(domain : string, category: string) : boolean {\r\n    return splitArrComma[domain] && splitArrComma[domain][category];\r\n}\r\n\r\nexport function getPropsTypeRecord(props : any, newcat :string , category : string, domain : string) {\r\n    if(isArrayTransform(domain, category)) {\r\n        return props[newcat][0];\r\n    }\r\n    return props[newcat];\r\n}\r\n\r\nexport function mergeModelJson(sModelName: string, oMdl: IOldModel) {\r\n    var categoryDescribedMap = {} as { [key: string]: IFModel.ICategoryDesc };\r\n    oMdl.bitindex = 0; // getDomainBitIndex(oMdl.domain, oModel);\r\n    oMdl.categoryDescribed = [];\r\n    // rectify category\r\n    oMdl.category = oMdl.category.map(function (cat: any) {\r\n        if (typeof cat === \"string\") {\r\n            return cat;\r\n        }\r\n        if (typeof cat.name !== \"string\") {\r\n            console.log(\"Missing name in object typed category in \" + JSON.stringify(cat) + \" in model \" + sModelName);\r\n            process.exit(-1);\r\n            //throw new Error('Domain ' + oMdl.domain + ' already loaded while loading ' + sModelName + '?');\r\n        }\r\n        categoryDescribedMap[cat.name] = cat;\r\n        oMdl.categoryDescribed.push(cat);\r\n        return cat.name;\r\n    });\r\n\r\n    var schema = new mongoose.Schema({ _id: Number });\r\n\r\n    var props = {};\r\n\r\n    var mongoCategories = calcMongoCats(oMdl.category);\r\n    mongoCategories.forEach((cat, index) => {\r\n\r\n        props[cat] = { type: \"String\", trim: true, _m_category: oMdl.category[index] }\r\n        if (isArrayTransform(oMdl.domain, oMdl.category[index])) {\r\n            props[cat] = [ props[cat] ];\r\n        }\r\n        }\r\n    );\r\n    oMdl.wordindex.forEach(rcat => {\r\n        var cat = makeMongoName(rcat);\r\n        if (!props[cat]) {\r\n            console.error(`model : ${sModelName} wordindex category \"${cat}\" is not in categories?`);\r\n            process.exit(-1);\r\n        }\r\n        getPropsTypeRecord(props,cat,rcat, oMdl.domain).index = true;\r\n        //props[cat].index = true;\r\n    });\r\n\r\n    oMdl.wordindex = oMdl.wordindex || [];\r\n    oMdl.exactmatch = oMdl.exactmatch || [];\r\n    // check that members of wordindex are in categories,\r\n    oMdl.wordindex = oMdl.wordindex || [];\r\n    oMdl.wordindex.forEach(function (sWordIndex) {\r\n        if (oMdl.category.indexOf(sWordIndex) < 0) {\r\n            throw new Error('Model wordindex \"' + sWordIndex + '\" not a category of domain ' + oMdl.domain + ' ');\r\n        }\r\n    });\r\n    oMdl.exactmatch = oMdl.exactmatch || [];\r\n    oMdl.exactmatch.forEach(function (sExactMatch) {\r\n        if (oMdl.category.indexOf(sExactMatch) < 0) {\r\n            throw new Error('Model exactmatch \"' + sExactMatch + '\" not a category of domain ' + oMdl.domain + ' ');\r\n        }\r\n    });\r\n    oMdl.columns = oMdl.columns || [];\r\n    oMdl.columns.forEach(function (sExactMatch) {\r\n        if (oMdl.category.indexOf(sExactMatch) < 0) {\r\n            throw new Error('Model column \"' + sExactMatch + '\" not a category of domain ' + oMdl.domain + ' ');\r\n        }\r\n    });\r\n\r\n    var s = getTextIndexCategories(oMdl);\r\n    var index = {};\r\n    s.forEach(textIndexCat => {\r\n        index[makeMongoName(textIndexCat)] = 'text';\r\n    })\r\n    //props[\"_id\"] = { type : Number};\r\n    return {\r\n        props: props,\r\n        index: index\r\n    };\r\n    // var schema = new mongoose.Schema(props);\r\n    // schema.index(index);\r\n} // loadmodel\r\n\r\n\r\n\r\n\r\nexport function transFormType(domain: string, category: string, val: any) {\r\n    if (splitArrComma[domain] && splitArrComma[domain][category]) {\r\n        if (val === \"n/a\") {\r\n            return [];\r\n        }\r\n        var args = val.split(\",\");\r\n        args = args.map(arg => arg.trim());\r\n        return args;\r\n    }\r\n    return val;\r\n}\r\n\r\n\r\n\r\nexport function mapOne(o: any, props: { [key: string]: string }, domain: string): any {\r\n    var res = {};\r\n    Object.keys(props).forEach(key => {\r\n        var val = o[key];\r\n\r\n\r\n        if (o[key] !== undefined) {\r\n            var val = o[key];\r\n            val = transFormType(domain, key, val);\r\n            res[props[key]] = val;\r\n        };\r\n    });\r\n    /*\r\n      \"synonyms\": {\r\n          \"element name\": [\r\n            \"aluminum\"\r\n          ]\r\n        }*/\r\n    var synonyms = o.synonyms || {};\r\n    Object.keys(synonyms).forEach(key => {\r\n        var category = key;\r\n        var value = o[category];\r\n        var syns = synonyms[key];\r\n        (res as any)._synonyms = (res as any)._synonyms || [];\r\n        (res as any)._synonyms.push({\r\n            \"category\": category,\r\n            \"fact\": value,\r\n            \"synonyms\": syns\r\n        });\r\n\r\n    });\r\n    return res;\r\n}\r\n\r\nexport function makeDocuments(data: any, oMdl: IOldModel): any {\r\n    var props = {};\r\n    oMdl.category.forEach(cat => {\r\n        props[cat] = makeMongoName(cat)\r\n    }\r\n    );\r\n    return data.map((o, index) => {\r\n        var r = mapOne(o, props, oMdl.domain);\r\n        // r._id = index + 1;\r\n        return r;\r\n    });\r\n}"],"sourceRoot":"ABC"}