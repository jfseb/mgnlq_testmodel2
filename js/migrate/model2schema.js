'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeDocuments = exports.mapOne = exports.transFormType = exports.mergeModelJson = exports.getPropsTypeRecord = exports.isArrayTransform = exports.makeModelDoc = exports.getTextIndexCategories = exports.calcMongoCats = exports.loadModelData = exports.loadModel = exports.readFileAsJSON = exports.makeMongoName = void 0;
/**
 * (C) gerd forstmann 2017
 *
 * convert model file into an mongoose schema
 */
//import * as intf from 'constants';
const debug = require("debug");
const _ = require("lodash");
//var IFModel = IFMatch.IModel;
var debuglog = debug('model');
const fs = require("fs");
const mongoose = require("mongoose");
///////////////////////////////////////////////
// hardcoded mappings
// these string properties are wrapped into an array, splitting at ,
// and trimming
var splitArrComma = {
    "FioriBOM": {
        // TODO: fiori intent must be reconstructed after splitting SemanticObject/SEemanticAction
        "fiori intent": true,
        "TransactionCode": true,
        "BusinessGroupName": true,
        ApplicationType: true,
        BusinessRoleName: true,
        BusinessCatalog: true,
        BusinessGroupDescription: true,
        SemanticObject: true,
        SemanticAction: true,
    }
};
;
function makeMongoName(s) {
    return s.replace(/[^a-zA-Z0-9]/g, '_');
}
exports.makeMongoName = makeMongoName;
function readFileAsJSON(filename) {
    var data = fs.readFileSync(filename, 'utf-8');
    try {
        return JSON.parse(data);
    }
    catch (e) {
        console.log("Content of file " + filename + " is no json" + e);
        process.exit(-1);
    }
    return undefined;
}
exports.readFileAsJSON = readFileAsJSON;
function loadModel(modelPath, sModelName) {
    debuglog(" loading " + sModelName + " ....");
    var oMdl = readFileAsJSON(modelPath + '/' + sModelName + ".model.json");
    return oMdl;
    //mergeModelJson(sModelName, oMdl);
    //    loadModelData(modelPath, oMdl, sModelName, oModel);
}
exports.loadModel = loadModel;
function loadModelData(modelPath, sModelName) {
    debuglog(" loading " + sModelName + " ....");
    var oMdlData = readFileAsJSON(modelPath + '/' + sModelName + ".data.json");
    return oMdlData;
}
exports.loadModelData = loadModelData;
function calcMongoCats(cats) {
    var props = {};
    var res = cats.map(cat => {
        var r = makeMongoName(cat);
        if (props[r]) {
            throw new Error(`${props[r]} and ${cat} yield conflicting mongodb property names`);
        }
        props[r] = cat;
        return r;
    });
    return res;
}
exports.calcMongoCats = calcMongoCats;
function getTextIndexCategories(oMdl) {
    return _.difference(oMdl.wordindex, oMdl.exactmatch);
}
exports.getTextIndexCategories = getTextIndexCategories;
function makeModelDoc(sModelName, oMdl) {
    var res = {};
    res.domain = oMdl.domain;
    res.domain_description = oMdl.description;
    res.modelname = sModelName,
        res.collectionname = sModelName;
    res._categories = [];
    oMdl.category.forEach(cat => {
        var categoryDesc = oMdl.categoryDescribed.filter(catrec => catrec.name === cat)[0] || {};
        var QBEColumnProps = {};
        if (categoryDesc.QBE) {
            QBEColumnProps.QBE = categoryDesc.QBE;
        }
        if (categoryDesc.LUNRIndex) {
            QBEColumnProps.LUNRIndex = categoryDesc.LUNRIndex;
        }
        if (categoryDesc.defaultWidth) {
            QBEColumnProps.defaultWidth = categoryDesc.defaultWidth || 100;
        }
        ;
        var mem = {
            category: cat,
            category_description: categoryDesc.description || "",
            QBEColumnProps: QBEColumnProps
        };
        if (oMdl.wordindex.indexOf(cat) >= 0) {
            mem.wordindex = true;
        }
        if (oMdl.exactmatch.indexOf(cat) >= 0) {
            mem.exactmatch = true;
        }
        if (oMdl.synonyms && oMdl.synonyms[cat]) {
            mem.category_synonyms = oMdl.synonyms[cat];
        }
        if (categoryDesc.QBEInclude) {
            mem.QBEColumnProps.QBEInclude = true;
        }
        // if(categoryDesc.importance) {
        //      mem.importance = categoryDesc.importance;
        //}
        res._categories.push(mem);
    });
    res.columns = oMdl.columns;
    return res;
}
exports.makeModelDoc = makeModelDoc;
function isArrayTransform(domain, category) {
    return splitArrComma[domain] && splitArrComma[domain][category];
}
exports.isArrayTransform = isArrayTransform;
function getPropsTypeRecord(props, newcat, category, domain) {
    if (isArrayTransform(domain, category)) {
        return props[newcat][0];
    }
    return props[newcat];
}
exports.getPropsTypeRecord = getPropsTypeRecord;
function mergeModelJson(sModelName, oMdl) {
    var categoryDescribedMap = {};
    oMdl.bitindex = 0; // getDomainBitIndex(oMdl.domain, oModel);
    oMdl.categoryDescribed = [];
    // rectify category
    oMdl.category = oMdl.category.map(function (cat) {
        if (typeof cat === "string") {
            return cat;
        }
        if (typeof cat.name !== "string") {
            console.log("Missing name in object typed category in " + JSON.stringify(cat) + " in model " + sModelName);
            process.exit(-1);
            //throw new Error('Domain ' + oMdl.domain + ' already loaded while loading ' + sModelName + '?');
        }
        categoryDescribedMap[cat.name] = cat;
        oMdl.categoryDescribed.push(cat);
        return cat.name;
    });
    var schema = new mongoose.Schema({ _id: Number });
    var props = {};
    var mongoCategories = calcMongoCats(oMdl.category);
    mongoCategories.forEach((cat, index) => {
        props[cat] = { type: "String", trim: true, _m_category: oMdl.category[index] };
        if (isArrayTransform(oMdl.domain, oMdl.category[index])) {
            props[cat] = [props[cat]];
        }
    });
    oMdl.wordindex.forEach(rcat => {
        var cat = makeMongoName(rcat);
        if (!props[cat]) {
            console.error(`model : ${sModelName} wordindex category "${cat}" is not in categories?`);
            process.exit(-1);
        }
        getPropsTypeRecord(props, cat, rcat, oMdl.domain).index = true;
        //props[cat].index = true;
    });
    oMdl.wordindex = oMdl.wordindex || [];
    oMdl.exactmatch = oMdl.exactmatch || [];
    // check that members of wordindex are in categories,
    oMdl.wordindex = oMdl.wordindex || [];
    oMdl.wordindex.forEach(function (sWordIndex) {
        if (oMdl.category.indexOf(sWordIndex) < 0) {
            throw new Error('Model wordindex "' + sWordIndex + '" not a category of domain ' + oMdl.domain + ' ');
        }
    });
    oMdl.exactmatch = oMdl.exactmatch || [];
    oMdl.exactmatch.forEach(function (sExactMatch) {
        if (oMdl.category.indexOf(sExactMatch) < 0) {
            throw new Error('Model exactmatch "' + sExactMatch + '" not a category of domain ' + oMdl.domain + ' ');
        }
    });
    oMdl.columns = oMdl.columns || [];
    oMdl.columns.forEach(function (sExactMatch) {
        if (oMdl.category.indexOf(sExactMatch) < 0) {
            throw new Error('Model column "' + sExactMatch + '" not a category of domain ' + oMdl.domain + ' ');
        }
    });
    var s = getTextIndexCategories(oMdl);
    var index = {};
    s.forEach(textIndexCat => {
        index[makeMongoName(textIndexCat)] = 'text';
    });
    //props["_id"] = { type : Number};
    return {
        props: props,
        index: index
    };
    // var schema = new mongoose.Schema(props);
    // schema.index(index);
} // loadmodel
exports.mergeModelJson = mergeModelJson;
function transFormType(domain, category, val) {
    if (splitArrComma[domain] && splitArrComma[domain][category]) {
        if (val === "n/a") {
            return [];
        }
        var args = val.split(",");
        args = args.map(arg => arg.trim());
        return args;
    }
    return val;
}
exports.transFormType = transFormType;
function mapOne(o, props, domain) {
    var res = {};
    Object.keys(props).forEach(key => {
        var val = o[key];
        if (o[key] !== undefined) {
            var val = o[key];
            val = transFormType(domain, key, val);
            res[props[key]] = val;
        }
        ;
    });
    /*
      "synonyms": {
          "element name": [
            "aluminum"
          ]
        }*/
    var synonyms = o.synonyms || {};
    Object.keys(synonyms).forEach(key => {
        var category = key;
        var value = o[category];
        var syns = synonyms[key];
        res._synonyms = res._synonyms || [];
        res._synonyms.push({
            "category": category,
            "fact": value,
            "synonyms": syns
        });
    });
    return res;
}
exports.mapOne = mapOne;
function makeDocuments(data, oMdl) {
    var props = {};
    oMdl.category.forEach(cat => {
        props[cat] = makeMongoName(cat);
    });
    return data.map((o, index) => {
        var r = mapOne(o, props, oMdl.domain);
        // r._id = index + 1;
        return r;
    });
}
exports.makeDocuments = makeDocuments;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9taWdyYXRlL21vZGVsMnNjaGVtYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUE7OztBQUVaOzs7O0dBSUc7QUFFSCxvQ0FBb0M7QUFDcEMsK0JBQStCO0FBRS9CLDRCQUE0QjtBQU01QiwrQkFBK0I7QUFFL0IsSUFBSSxRQUFRLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBRTlCLHlCQUF5QjtBQUV6QixxQ0FBcUM7QUFJckMsK0NBQStDO0FBQy9DLHFCQUFxQjtBQUVyQixvRUFBb0U7QUFDcEUsZUFBZTtBQUVmLElBQUksYUFBYSxHQUFHO0lBQ2hCLFVBQVUsRUFBRTtRQUNSLDBGQUEwRjtRQUMxRixjQUFjLEVBQUUsSUFBSTtRQUNwQixpQkFBaUIsRUFBRSxJQUFJO1FBQ3ZCLG1CQUFtQixFQUFFLElBQUk7UUFDekIsZUFBZSxFQUFFLElBQUk7UUFDckIsZ0JBQWdCLEVBQUUsSUFBSTtRQUN0QixlQUFlLEVBQUUsSUFBSTtRQUNyQix3QkFBd0IsRUFBRSxJQUFJO1FBQzlCLGNBQWMsRUFBRSxJQUFJO1FBQ3BCLGNBQWMsRUFBRSxJQUFJO0tBQ3ZCO0NBQ0osQ0FBQztBQWdCRCxDQUFDO0FBa0JGLFNBQWdCLGFBQWEsQ0FBQyxDQUFTO0lBQ25DLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDM0MsQ0FBQztBQUZELHNDQUVDO0FBRUQsU0FBZ0IsY0FBYyxDQUFDLFFBQWdCO0lBQzNDLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzlDLElBQUk7UUFDQSxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDM0I7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNSLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLEdBQUcsUUFBUSxHQUFHLGFBQWEsR0FBRyxDQUFDLENB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Q0FBQyxHQUFHLENBQUMsRUFBRTtRQUN4QixLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQ25DLENBQUMsQ0FDQSxDQUFDO0lBQ0YsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFO1FBQ3pCLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN0QyxxQkFBcUI7UUFDckIsT0FBTyxDQUFDLENBQUM7SUFDYixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFYRCxzQ0FXQyIsImZpbGUiOiJtaWdyYXRlL21vZGVsMnNjaGVtYS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xyXG5cclxuLyoqXHJcbiAqIChDKSBnZXJkIGZvcnN0bWFubiAyMDE3XHJcbiAqXHJcbiAqIGNvbnZlcnQgbW9kZWwgZmlsZSBpbnRvIGFuIG1vbmdvb3NlIHNjaGVtYVxyXG4gKi9cclxuXHJcbi8vaW1wb3J0ICogYXMgaW50ZiBmcm9tICdjb25zdGFudHMnO1xyXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XHJcblxyXG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XHJcblxyXG4vL2ltcG9ydCB7IElGTW9kZWwgfSogIGFzIElGTW9kZWwgIGZyb20gJy4uL21hdGNoL2lmbWF0Y2gnO1xyXG5cclxuXHJcbmltcG9ydCB7IElGTW9kZWwgYXMgSUZNb2RlbCB9IGZyb20gJ21nbmxxX21vZGVsJztcclxuLy92YXIgSUZNb2RlbCA9IElGTWF0Y2guSU1vZGVsO1xyXG5cclxudmFyIGRlYnVnbG9nID0gZGVidWcoJ21vZGVsJyk7XHJcblxyXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XHJcblxyXG5pbXBvcnQgKiBhcyBtb25nb29zZSBmcm9tICdtb25nb29zZSc7XHJcblxyXG5cclxuXHJcbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXHJcbi8vIGhhcmRjb2RlZCBtYXBwaW5nc1xyXG5cclxuLy8gdGhlc2Ugc3RyaW5nIHByb3BlcnRpZXMgYXJlIHdyYXBwZWQgaW50byBhbiBhcnJheSwgc3BsaXR0aW5nIGF0ICxcclxuLy8gYW5kIHRyaW1taW5nXHJcblxyXG52YXIgc3BsaXRBcnJDb21tYSA9IHtcclxuICAgIFwiRmlvcmlCT01cIjoge1xyXG4gICAgICAgIC8vIFRPRE86IGZpb3JpIGludGVudCBtdXN0IGJlIHJlY29uc3RydWN0ZWQgYWZ0ZXIgc3BsaXR0aW5nIFNlbWFudGljT2JqZWN0L1NFZW1hbnRpY0FjdGlvblxyXG4gICAgICAgIFwiZmlvcmkgaW50ZW50XCI6IHRydWUsXHJcbiAgICAgICAgXCJUcmFuc2FjdGlvbkNvZGVcIjogdHJ1ZSxcclxuICAgICAgICBcIkJ1c2luZXNzR3JvdXBOYW1lXCI6IHRydWUsXHJcbiAgICAgICAgQXBwbGljYXRpb25UeXBlOiB0cnVlLFxyXG4gICAgICAgIEJ1c2luZXNzUm9sZU5hbWU6IHRydWUsXHJcbiAgICAgICAgQnVzaW5lc3NDYXRhbG9nOiB0cnVlLFxyXG4gICAgICAgIEJ1c2luZXNzR3JvdXBEZXNjcmlwdGlvbjogdHJ1ZSxcclxuICAgICAgICBTZW1hbnRpY09iamVjdDogdHJ1ZSxcclxuICAgICAgICBTZW1hbnRpY0FjdGlvbjogdHJ1ZSxcclxuICAgIH1cclxufTtcclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBPbGRDYXRlZ29yeURlc2Mge1xyXG4gICAgbmFtZTogc3RyaW5nO1xyXG4gICAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XHJcbiAgICBrZXk/OiBzdHJpbmc7XHJcbiAgICBRQkU/OiBib29sZWFuLFxyXG4gICAgZGVmYXVsdFdpZHRoPzogbnVtYmVyLFxyXG4gICAgaW1wb3J0YW5jZTogbnVtYmVyLFxyXG4gICAgTFVOUkluZGV4OiBib29sZWFuLFxyXG4gICAgUUJFSW5jbHVkZTogYm9vbGVhblxyXG59O1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJT2xkTW9kZWwge1xyXG4gICAgZG9tYWluOiBzdHJpbmc7XHJcbiAgICBiaXRpbmRleDogbnVtYmVyO1xyXG4gICAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XHJcbiAgICB0b29sPzogYW55LFxyXG4gICAgdG9vbGhpZGRlbj86IGJvb2xlYW47XHJcbiAgICBzeW5vbnltcz86IHtcclxuICAgICAgICBba2V5OiBzdHJpbmddOiBzdHJpbmdbXTtcclxuICAgIH07XHJcbiAgICBjYXRlZ29yeURlc2NyaWJlZDogT2xkQ2F0ZWdvcnlEZXNjW10sXHJcbiAgICBjYXRlZ29yeTogc3RyaW5nW107XHJcbiAgICBjb2x1bW5zPzogc3RyaW5nW107XHJcbiAgICB3b3JkaW5kZXg6IHN0cmluZ1tdO1xyXG4gICAgZXhhY3RtYXRjaD86IHN0cmluZ1tdO1xyXG4gICAgaGlkZGVuOiBzdHJpbmdbXTtcclxufVxyXG5leHBvcnQgZnVuY3Rpb24gbWFrZU1vbmdvTmFtZShzOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHMucmVwbGFjZSgvW15hLXpBLVowLTldL2csICdfJyk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiByZWFkRmlsZUFzSlNPTihmaWxlbmFtZTogc3RyaW5nKTogYW55IHtcclxuICAgIHZhciBkYXRhID0gZnMucmVhZEZpbGVTeW5jKGZpbGVuYW1lLCAndXRmLTgnKTtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoZGF0YSk7XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJDb250ZW50IG9mIGZpbGUgXCIgKyBmaWxlbmFtZSArIFwiIGlzIG5vIGpzb25cIiArIGUpO1xyXG4gICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRNb2RlbChtb2RlbFBhdGg6IHN0cmluZywgc01vZGVsTmFtZTogc3RyaW5nKSB7XHJcbiAgICBkZWJ1Z2xvZyhcIiBsb2FkaW5nIFwiICsgc01vZGVsTmFtZSArIFwiIC4uLi5cIik7XHJcbiAgICB2YXIgb01kbCA9IHJlYWRGaWxlQXNKU09OKG1vZGVsUGF0aCArICcvJyArIHNNb2RlbE5hbWUgKyBcIi5tb2RlbC5qc29uXCIpIGFzIElPbGRNb2RlbDtcclxuICAgIHJldHVybiBvTWRsO1xyXG4gICAgLy9tZXJnZU1vZGVsSnNvbihzTW9kZWxOYW1lLCBvTWRsKTtcclxuICAgIC8vICAgIGxvYWRNb2RlbERhdGEobW9kZWxQYXRoLCBvTWRsLCBzTW9kZWxOYW1lLCBvTW9kZWwpO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRNb2RlbERhdGEobW9kZWxQYXRoOiBzdHJpbmcsIHNNb2RlbE5hbWU6IHN0cmluZyk6IGFueVtdIHtcclxuICAgIGRlYnVnbG9nKFwiIGxvYWRpbmcgXCIgKyBzTW9kZWxOYW1lICsgXCIgLi4uLlwiKTtcclxuICAgIHZhciBvTWRsRGF0YSA9IHJlYWRGaWxlQXNKU09OKG1vZGVsUGF0aCArICcvJyArIHNNb2RlbE5hbWUgKyBcIi5kYXRhLmpzb25cIikgYXMgYW55O1xyXG4gICAgcmV0dXJuIG9NZGxEYXRhO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNhbGNNb25nb0NhdHMoY2F0czogc3RyaW5nW10pOiBzdHJpbmdbXSB7XHJcbiAgICB2YXIgcHJvcHMgPSB7fTtcclxuICAgIHZhciByZXMgPSBjYXRzLm1hcChjYXQgPT4ge1xyXG4gICAgICAgIHZhciByID0gbWFrZU1vbmdvTmFtZShjYXQpO1xyXG4gICAgICAgIGlmIChwcm9wc1tyXSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7cHJvcHNbcl19IGFuZCAke2NhdH0geWllbGQgY29uZmxpY3RpbmcgbW9uZ29kYiBwcm9wZXJ0eSBuYW1lc2ApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBwcm9wc1tyXSA9IGNhdDtcclxuICAgICAgICByZXR1cm4gcjtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHJlcztcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFRleHRJbmRleENhdGVnb3JpZXMob01kbDogSU9sZE1vZGVsKTogc3RyaW5nW10ge1xyXG4gICAgcmV0dXJuIF8uZGlmZmVyZW5jZShvTWRsLndvcmRpbmRleCwgb01kbC5leGFjdG1hdGNoKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VNb2RlbERvYyhzTW9kZWxOYW1lOiBzdHJpbmcsIG9NZGw6IElPbGRNb2RlbCk6IElGTW9kZWwuSU1vZGVsRG9jIHtcclxuICAgIHZhciByZXMgPSB7fSBhcyBJRk1vZGVsLklNb2RlbERvYztcclxuICAgIHJlcy5kb21haW4gPSBvTWRsLmRvbWFpbjtcclxuICAgIHJlcy5kb21haW5fZGVzY3JpcHRpb24gPSBvTWRsLmRlc2NyaXB0aW9uO1xyXG4gICAgcmVzLm1vZGVsbmFtZSA9IHNNb2RlbE5hbWUsXHJcbiAgICAgICAgcmVzLmNvbGxlY3Rpb25uYW1lID0gc01vZGVsTmFtZTtcclxuICAgIHJlcy5fY2F0ZWdvcmllcyA9IFtdO1xyXG4gICAgb01kbC5jYXRlZ29yeS5mb3JFYWNoKGNhdCA9PiB7XHJcbiAgICAgICAgdmFyIGNhdGVnb3J5RGVzYyA9IG9NZGwuY2F0ZWdvcnlEZXNjcmliZWQuZmlsdGVyKGNhdHJlYyA9PiBjYXRyZWMubmFtZSA9PT0gY2F0KVswXSB8fCB7fSBhcyBPbGRDYXRlZ29yeURlc2M7XHJcbiAgICAgICAgdmFyIFFCRUNvbHVtblByb3BzID0ge30gYXMgSUZNb2RlbC5RQkVDb2x1bW5Qcm9wO1xyXG5cclxuICAgICAgICBpZiAoY2F0ZWdvcnlEZXNjLlFCRSkge1xyXG4gICAgICAgICAgICBRQkVDb2x1bW5Qcm9wcy5RQkUgPSBjYXRlZ29yeURlc2MuUUJFO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY2F0ZWdvcnlEZXNjLkxVTlJJbmRleCkge1xyXG4gICAgICAgICAgICBRQkVDb2x1bW5Qcm9wcy5MVU5SSW5kZXggPSBjYXRlZ29yeURlc2MuTFVOUkluZGV4O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY2F0ZWdvcnlEZXNjLmRlZmF1bHRXaWR0aCkge1xyXG4gICAgICAgICAgICBRQkVDb2x1bW5Qcm9wcy5kZWZhdWx0V2lkdGggPSBjYXRlZ29yeURlc2MuZGVmYXVsdFdpZHRoIHx8IDEwMDtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHZhciBtZW0gPVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBjYXRlZ29yeTogY2F0LFxyXG4gICAgICAgICAgICAgICAgY2F0ZWdvcnlfZGVzY3JpcHRpb246IGNhdGVnb3J5RGVzYy5kZXNjcmlwdGlvbiB8fCBcIlwiLFxyXG4gICAgICAgICAgICAgICAgUUJFQ29sdW1uUHJvcHM6IFFCRUNvbHVtblByb3BzXHJcbiAgICAgICAgICAgIH0gYXMgSUZNb2RlbC5JTW9kZWxDYXRlZ29yeVJlYztcclxuICAgICAgICBpZiAob01kbC53b3JkaW5kZXguaW5kZXhPZihjYXQpID49IDApIHtcclxuICAgICAgICAgICAgbWVtLndvcmRpbmRleCA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvTWRsLmV4YWN0bWF0Y2guaW5kZXhPZihjYXQpID49IDApIHtcclxuICAgICAgICAgICAgbWVtLmV4YWN0bWF0Y2ggPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAob01kbC5zeW5vbnltcyAmJiBvTWRsLnN5bm9ueW1zW2NhdF0pIHtcclxuICAgICAgICAgICAgbWVtLmNhdGVnb3J5X3N5bm9ueW1zID0gb01kbC5zeW5vbnltc1tjYXRdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY2F0ZWdvcnlEZXNjLlFCRUluY2x1ZGUpIHtcclxuICAgICAgICAgICAgbWVtLlFCRUNvbHVtblByb3BzLlFCRUluY2x1ZGUgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBpZihjYXRlZ29yeURlc2MuaW1wb3J0YW5jZSkge1xyXG4gICAgICAgIC8vICAgICAgbWVtLmltcG9ydGFuY2UgPSBjYXRlZ29yeURlc2MuaW1wb3J0YW5jZTtcclxuICAgICAgICAvL31cclxuICAgICAgICByZXMuX2NhdGVnb3JpZXMucHVzaChtZW0pO1xyXG4gICAgfSk7XHJcbiAgICByZXMuY29sdW1ucyA9IG9NZGwuY29sdW1ucztcclxuICAgIHJldHVybiByZXM7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc0FycmF5VHJhbnNmb3JtKGRvbWFpbiA6IHN0cmluZywgY2F0ZWdvcnk6IHN0cmluZykgOiBib29sZWFuIHtcclxuICAgIHJldHVybiBzcGxpdEFyckNvbW1hW2RvbWFpbl0gJiYgc3BsaXRBcnJDb21tYVtkb21haW5dW2NhdGVnb3J5XTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFByb3BzVHlwZVJlY29yZChwcm9wcyA6IGFueSwgbmV3Y2F0IDpzdHJpbmcgLCBjYXRlZ29yeSA6IHN0cmluZywgZG9tYWluIDogc3RyaW5nKSB7XHJcbiAgICBpZihpc0FycmF5VHJhbnNmb3JtKGRvbWFpbiwgY2F0ZWdvcnkpKSB7XHJcbiAgICAgICAgcmV0dXJuIHByb3BzW25ld2NhdF1bMF07XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcHJvcHNbbmV3Y2F0XTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1lcmdlTW9kZWxKc29uKHNNb2RlbE5hbWU6IHN0cmluZywgb01kbDogSU9sZE1vZGVsKSB7XHJcbiAgICB2YXIgY2F0ZWdvcnlEZXNjcmliZWRNYXAgPSB7fSBhcyB7IFtrZXk6IHN0cmluZ106IElGTW9kZWwuSUNhdGVnb3J5RGVzYyB9O1xyXG4gICAgb01kbC5iaXRpbmRleCA9IDA7IC8vIGdldERvbWFpbkJpdEluZGV4KG9NZGwuZG9tYWluLCBvTW9kZWwpO1xyXG4gICAgb01kbC5jYXRlZ29yeURlc2NyaWJlZCA9IFtdO1xyXG4gICAgLy8gcmVjdGlmeSBjYXRlZ29yeVxyXG4gICAgb01kbC5jYXRlZ29yeSA9IG9NZGwuY2F0ZWdvcnkubWFwKGZ1bmN0aW9uIChjYXQ6IGFueSkge1xyXG4gICAgICAgIGlmICh0eXBlb2YgY2F0ID09PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjYXQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0eXBlb2YgY2F0Lm5hbWUgIT09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJNaXNzaW5nIG5hbWUgaW4gb2JqZWN0IHR5cGVkIGNhdGVnb3J5IGluIFwiICsgSlNPTi5zdHJpbmdpZnkoY2F0KSArIFwiIGluIG1vZGVsIFwiICsgc01vZGVsTmFtZSk7XHJcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XHJcbiAgICAgICAgICAgIC8vdGhyb3cgbmV3IEVycm9yKCdEb21haW4gJyArIG9NZGwuZG9tYWluICsgJyBhbHJlYWR5IGxvYWRlZCB3aGlsZSBsb2FkaW5nICcgKyBzTW9kZWxOYW1lICsgJz8nKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0ZWdvcnlEZXNjcmliZWRNYXBbY2F0Lm5hbWVdID0gY2F0O1xyXG4gICAgICAgIG9NZGwuY2F0ZWdvcnlEZXNjcmliZWQucHVzaChjYXQpO1xyXG4gICAgICAgIHJldHVybiBjYXQubmFtZTtcclxuICAgIH0pO1xyXG5cclxuICAgIHZhciBzY2hlbWEgPSBuZXcgbW9uZ29vc2UuU2NoZW1hKHsgX2lkOiBOdW1iZXIgfSk7XHJcblxyXG4gICAgdmFyIHByb3BzID0ge307XHJcblxyXG4gICAgdmFyIG1vbmdvQ2F0ZWdvcmllcyA9IGNhbGNNb25nb0NhdHMob01kbC5jYXRlZ29yeSk7XHJcbiAgICBtb25nb0NhdGVnb3JpZXMuZm9yRWFjaCgoY2F0LCBpbmRleCkgPT4ge1xyXG5cclxuICAgICAgICBwcm9wc1tjYXRdID0geyB0eXBlOiBcIlN0cmluZ1wiLCB0cmltOiB0cnVlLCBfbV9jYXRlZ29yeTogb01kbC5jYXRlZ29yeVtpbmRleF0gfVxyXG4gICAgICAgIGlmIChpc0FycmF5VHJhbnNmb3JtKG9NZGwuZG9tYWluLCBvTWRsLmNhdGVnb3J5W2luZGV4XSkpIHtcclxuICAgICAgICAgICAgcHJvcHNbY2F0XSA9IFsgcHJvcHNbY2F0XSBdO1xyXG4gICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICApO1xyXG4gICAgb01kbC53b3JkaW5kZXguZm9yRWFjaChyY2F0ID0+IHtcclxuICAgICAgICB2YXIgY2F0ID0gbWFrZU1vbmdvTmFtZShyY2F0KTtcclxuICAgICAgICBpZiAoIXByb3BzW2NhdF0pIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgbW9kZWwgOiAke3NNb2RlbE5hbWV9IHdvcmRpbmRleCBjYXRlZ29yeSBcIiR7Y2F0fVwiIGlzIG5vdCBpbiBjYXRlZ29yaWVzP2ApO1xyXG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBnZXRQcm9wc1R5cGVSZWNvcmQocHJvcHMsY2F0LHJjYXQsIG9NZGwuZG9tYWluKS5pbmRleCA9IHRydWU7XHJcbiAgICAgICAgLy9wcm9wc1tjYXRdLmluZGV4ID0gdHJ1ZTtcclxuICAgIH0pO1xyXG5cclxuICAgIG9NZGwud29yZGluZGV4ID0gb01kbC53b3JkaW5kZXggfHwgW107XHJcbiAgICBvTWRsLmV4YWN0bWF0Y2ggPSBvTWRsLmV4YWN0bWF0Y2ggfHwgW107XHJcbiAgICAvLyBjaGVjayB0aGF0IG1lbWJlcnMgb2Ygd29yZGluZGV4IGFyZSBpbiBjYXRlZ29yaWVzLFxyXG4gICAgb01kbC53b3JkaW5kZXggPSBvTWRsLndvcmRpbmRleCB8fCBbXTtcclxuICAgIG9NZGwud29yZGluZGV4LmZvckVhY2goZnVuY3Rpb24gKHNXb3JkSW5kZXgpIHtcclxuICAgICAgICBpZiAob01kbC5jYXRlZ29yeS5pbmRleE9mKHNXb3JkSW5kZXgpIDwgMCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01vZGVsIHdvcmRpbmRleCBcIicgKyBzV29yZEluZGV4ICsgJ1wiIG5vdCBhIGNhdGVnb3J5IG9mIGRvbWFpbiAnICsgb01kbC5kb21haW4gKyAnICcpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgb01kbC5leGFjdG1hdGNoID0gb01kbC5leGFjdG1hdGNoIHx8IFtdO1xyXG4gICAgb01kbC5leGFjdG1hdGNoLmZvckVhY2goZnVuY3Rpb24gKHNFeGFjdE1hdGNoKSB7XHJcbiAgICAgICAgaWYgKG9NZGwuY2F0ZWdvcnkuaW5kZXhPZihzRXhhY3RNYXRjaCkgPCAwKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTW9kZWwgZXhhY3RtYXRjaCBcIicgKyBzRXhhY3RNYXRjaCArICdcIiBub3QgYSBjYXRlZ29yeSBvZiBkb21haW4gJyArIG9NZGwuZG9tYWluICsgJyAnKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIG9NZGwuY29sdW1ucyA9IG9NZGwuY29sdW1ucyB8fCBbXTtcclxuICAgIG9NZGwuY29sdW1ucy5mb3JFYWNoKGZ1bmN0aW9uIChzRXhhY3RNYXRjaCkge1xyXG4gICAgICAgIGlmIChvTWRsLmNhdGVnb3J5LmluZGV4T2Yoc0V4YWN0TWF0Y2gpIDwgMCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01vZGVsIGNvbHVtbiBcIicgKyBzRXhhY3RNYXRjaCArICdcIiBub3QgYSBjYXRlZ29yeSBvZiBkb21haW4gJyArIG9NZGwuZG9tYWluICsgJyAnKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICB2YXIgcyA9IGdldFRleHRJbmRleENhdGVnb3JpZXMob01kbCk7XHJcbiAgICB2YXIgaW5kZXggPSB7fTtcclxuICAgIHMuZm9yRWFjaCh0ZXh0SW5kZXhDYXQgPT4ge1xyXG4gICAgICAgIGluZGV4W21ha2VNb25nb05hbWUodGV4dEluZGV4Q2F0KV0gPSAndGV4dCc7XHJcbiAgICB9KVxyXG4gICAgLy9wcm9wc1tcIl9pZFwiXSA9IHsgdHlwZSA6IE51bWJlcn07XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHByb3BzOiBwcm9wcyxcclxuICAgICAgICBpbmRleDogaW5kZXhcclxuICAgIH07XHJcbiAgICAvLyB2YXIgc2NoZW1hID0gbmV3IG1vbmdvb3NlLlNjaGVtYShwcm9wcyk7XHJcbiAgICAvLyBzY2hlbWEuaW5kZXgoaW5kZXgpO1xyXG59IC8vIGxvYWRtb2RlbFxyXG5cclxuXHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRyYW5zRm9ybVR5cGUoZG9tYWluOiBzdHJpbmcsIGNhdGVnb3J5OiBzdHJpbmcsIHZhbDogYW55KSB7XHJcbiAgICBpZiAoc3BsaXRBcnJDb21tYVtkb21haW5dICYmIHNwbGl0QXJyQ29tbWFbZG9tYWluXVtjYXRlZ29yeV0pIHtcclxuICAgICAgICBpZiAodmFsID09PSBcIm4vYVwiKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGFyZ3MgPSB2YWwuc3BsaXQoXCIsXCIpO1xyXG4gICAgICAgIGFyZ3MgPSBhcmdzLm1hcChhcmcgPT4gYXJnLnRyaW0oKSk7XHJcbiAgICAgICAgcmV0dXJuIGFyZ3M7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmFsO1xyXG59XHJcblxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBtYXBPbmUobzogYW55LCBwcm9wczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSwgZG9tYWluOiBzdHJpbmcpOiBhbnkge1xyXG4gICAgdmFyIHJlcyA9IHt9O1xyXG4gICAgT2JqZWN0LmtleXMocHJvcHMpLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgICB2YXIgdmFsID0gb1trZXldO1xyXG5cclxuXHJcbiAgICAgICAgaWYgKG9ba2V5XSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHZhciB2YWwgPSBvW2tleV07XHJcbiAgICAgICAgICAgIHZhbCA9IHRyYW5zRm9ybVR5cGUoZG9tYWluLCBrZXksIHZhbCk7XHJcbiAgICAgICAgICAgIHJlc1twcm9wc1trZXldXSA9IHZhbDtcclxuICAgICAgICB9O1xyXG4gICAgfSk7XHJcbiAgICAvKlxyXG4gICAgICBcInN5bm9ueW1zXCI6IHtcclxuICAgICAgICAgIFwiZWxlbWVudCBuYW1lXCI6IFtcclxuICAgICAgICAgICAgXCJhbHVtaW51bVwiXHJcbiAgICAgICAgICBdXHJcbiAgICAgICAgfSovXHJcbiAgICB2YXIgc3lub255bXMgPSBvLnN5bm9ueW1zIHx8IHt9O1xyXG4gICAgT2JqZWN0LmtleXMoc3lub255bXMpLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgICB2YXIgY2F0ZWdvcnkgPSBrZXk7XHJcbiAgICAgICAgdmFyIHZhbHVlID0gb1tjYXRlZ29yeV07XHJcbiAgICAgICAgdmFyIHN5bnMgPSBzeW5vbnltc1trZXldO1xyXG4gICAgICAgIChyZXMgYXMgYW55KS5fc3lub255bXMgPSAocmVzIGFzIGFueSkuX3N5bm9ueW1zIHx8IFtdO1xyXG4gICAgICAgIChyZXMgYXMgYW55KS5fc3lub255bXMucHVzaCh7XHJcbiAgICAgICAgICAgIFwiY2F0ZWdvcnlcIjogY2F0ZWdvcnksXHJcbiAgICAgICAgICAgIFwiZmFjdFwiOiB2YWx1ZSxcclxuICAgICAgICAgICAgXCJzeW5vbnltc1wiOiBzeW5zXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcmVzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWFrZURvY3VtZW50cyhkYXRhOiBhbnksIG9NZGw6IElPbGRNb2RlbCk6IGFueSB7XHJcbiAgICB2YXIgcHJvcHMgPSB7fTtcclxuICAgIG9NZGwuY2F0ZWdvcnkuZm9yRWFjaChjYXQgPT4ge1xyXG4gICAgICAgIHByb3BzW2NhdF0gPSBtYWtlTW9uZ29OYW1lKGNhdClcclxuICAgIH1cclxuICAgICk7XHJcbiAgICByZXR1cm4gZGF0YS5tYXAoKG8sIGluZGV4KSA9PiB7XHJcbiAgICAgICAgdmFyIHIgPSBtYXBPbmUobywgcHJvcHMsIG9NZGwuZG9tYWluKTtcclxuICAgICAgICAvLyByLl9pZCA9IGluZGV4ICsgMTtcclxuICAgICAgICByZXR1cm4gcjtcclxuICAgIH0pO1xyXG59Il19
